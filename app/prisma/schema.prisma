// Prisma schema для AYN Marketplace
// Спільна база даних для бота та міні-додатку

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Користувачі
model User {
  id                      Int      @id @default(autoincrement())
  telegramId              BigInt   @unique
  username                String?
  firstName               String?
  lastName                String?
  phone                   String?
  avatar                  String?
  balance                 Float    @default(0)
  rating                  Float    @default(5.0)
  reviewsCount            Int      @default(0)
  isActive                Boolean  @default(true)
  listingPackagesBalance  Int      @default(1) // Перше оголошення безкоштовне
  hasUsedFreeAd           Boolean  @default(false) // Чи використав перше безкоштовне оголошення
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  listings                Listing[]
  telegramListings        TelegramListing[]
  favorites               Favorite[]
  transactions            Transaction[]
  reviews                 Review[]
  payments                Payment[]
  listingPackages         ListingPackagePurchase[]
  promotionPurchases      PromotionPurchase[]

  @@index([telegramId])
  @@index([isActive])
}

// Оголошення
model Listing {
  id                Int      @id @default(autoincrement())
  userId            Int
  title             String
  description       String
  price             String
  currency          String?  // UAH, EUR, USD
  isFree            Boolean  @default(false)
  category          String
  subcategory       String?
  condition         String?  // new, like_new, good, fair
  location          String
  views             Int      @default(0)
  status            String   @default("pending_moderation") // draft, pending_moderation, approved, active, sold, expired, deactivated, hidden
  moderationStatus  String   @default("pending") // pending, approved (rejected listings are deleted)
  rejectionReason   String?  // DEPRECATED: Причина відхилення модератором (rejected listings are now deleted)
  promotionType     String?  // null, highlighted, top_category, vip
  promotionEnds     DateTime?
  expiresAt         DateTime? // Дата закінчення активності оголошення (30 днів)
  images            String   // JSON array of image URLs
  tags              String?  // JSON array of tags
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  publishedAt       DateTime?
  moderatedAt       DateTime? // Дата модерації
  moderatedBy       Int?     // ID адміна який модерував

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  favorites         Favorite[]
  viewsHistory      ViewHistory[]

  @@index([userId])
  @@index([category])
  @@index([subcategory])
  @@index([status])
  @@index([moderationStatus])
  @@index([isFree])
  @@index([createdAt])
  @@index([publishedAt])
  @@index([currency])
  @@index([views])
  @@index([promotionType, promotionEnds])
  @@index([category, subcategory, status])
  @@index([status, createdAt])
  @@index([status, views])
  @@index([userId, status])
  @@index([userId, category])
  @@index([status, isFree, createdAt])
  @@index([moderationStatus, createdAt])
  @@index([expiresAt])
  @@index([status, expiresAt])
}

// Оголошення з Telegram-бота (TelegramListing таблиця, яку створює бот)
model TelegramListing {
  id               Int      @id @default(autoincrement())
  userId           Int
  title            String
  description      String
  price            Float
  currency         String?  @default("EUR")
  category         String
  subcategory      String?
  condition        String   // NOT NULL в БД
  location         String?
  images           String   // JSON array of Telegram file_ids
  status           String   @default("pending_moderation")
  moderationStatus String   @default("pending")
  rejectionReason  String?
  publishedAt      DateTime?
  moderatedAt      DateTime?
  moderatedBy      Int?
  channelMessageId Int?     // ID повідомлення в Telegram каналі (додається динамічно)
  publicationTariff String? // Тариф публікації (standard, highlighted, top_category, vip)
  paymentStatus     String?  @default("pending") // Статус оплати (pending, paid, failed)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @default(now())

  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([moderationStatus])
  @@index([createdAt])
  @@index([category])
}

// Обране
model Favorite {
  id        Int      @id @default(autoincrement())
  userId    Int
  listingId Int
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
  @@index([userId])
  @@index([listingId])
}

// Транзакції
model Transaction {
  id            Int      @id @default(autoincrement())
  userId        Int
  type          String   // payment, refund, withdrawal
  amount        Float
  currency      String   @default("EUR")
  paymentMethod String?  // crypto, stars, stripe, sepa
  status        String   @default("pending") // pending, completed, failed
  description   String?
  metadata      String?  // JSON
  createdAt     DateTime @default(now())
  completedAt   DateTime?

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([type, status])
}

// Платежі Monobank
model Payment {
  id            Int      @id @default(autoincrement())
  userId        Int
  invoiceId     String   @unique // ID інвойсу від Monobank
  amount        Int      // Сума в центах EUR (для оплати через Monobank)
  amountEur     Float    // Оригінальна сума в EUR (для поповнення балансу)
  currency      String   @default("EUR") // EUR
  status        String   @default("created") // created, processing, success, failure, expired
  pageUrl       String?  // URL для оплати
  webhookData   String?  // JSON дані з вебхука
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  completedAt   DateTime?

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([invoiceId])
  @@index([status])
  @@index([createdAt])
}

// Відгуки
model Review {
  id        Int      @id @default(autoincrement())
  userId    Int      // хто залишив відгук
  targetId  Int      // про кого відгук (User.id)
  listingId Int?
  rating    Int      // 1-5
  comment   String?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([targetId])
  @@index([listingId])
  @@index([createdAt])
}

// Історія переглядів
model ViewHistory {
  id        Int      @id @default(autoincrement())
  listingId Int
  viewerTelegramId BigInt?
  viewedAt  DateTime @default(now())
  userAgent String?
  ipAddress String?

  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@index([viewerTelegramId])
  @@index([viewedAt])
  @@unique([listingId, viewerTelegramId])
}

// Категорії (статичні дані, можна винести в константи)
// Але якщо потрібна динамічна зміна, можна додати:
model Category {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  icon        String
  parentId    Int?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  parent      Category?  @relation("CategoryParent", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryParent")

  @@index([parentId])
  @@index([isActive, sortOrder])
}

// Адміністратори (для бота)
model Admin {
  id            Int      @id @default(autoincrement())
  userId        Int      @unique
  username      String?
  addedBy       Int?
  addedDate     DateTime @default(now())
  isSuperadmin  Boolean  @default(false)

  @@index([userId])
  @@index([isSuperadmin])
}

// Налаштування системи
model SystemSettings {
  id                Int      @id @default(autoincrement())
  key               String   @unique
  value             String   // JSON для складних значень
  description       String?
  updatedAt         DateTime @updatedAt
  updatedBy         Int?     // ID адміна

  @@index([key])
}

// Пакети оголошень (покупки користувачів)
model ListingPackagePurchase {
  id                Int      @id @default(autoincrement())
  userId            Int
  packageType       String   // "single_1", "pack_5", "pack_10"
  listingsCount     Int      // Кількість оголошень в пакеті
  price             Float    // Ціна в EUR
  paymentMethod     String   // "balance", "direct"
  status            String   @default("pending") // pending, completed, refunded
  invoiceId         String?  // ID інвойсу від Monobank (для direct payment)
  paidAt            DateTime? // Дата оплати
  createdAt         DateTime @default(now())
  expiresAt         DateTime? // Термін дії (наприклад 1 рік)

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([invoiceId])
}

// Покупки реклами/просування
model PromotionPurchase {
  id                Int      @id @default(autoincrement())
  userId            Int
  listingId         Int?     // Якщо прив'язано до конкретного оголошення
  promotionType     String   // "highlighted", "top_category", "vip"
  price             Float    // Ціна в EUR
  duration          Int      @default(7) // Тривалість в днях
  paymentMethod     String   // "balance", "direct"
  status            String   @default("pending") // pending, paid, active, completed, refunded
  invoiceId         String?  // ID інвойсу від Monobank (для direct payment)
  startsAt          DateTime?
  endsAt            DateTime?
  createdAt         DateTime @default(now())

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([listingId])
  @@index([status])
  @@index([promotionType])
  @@index([createdAt])
  @@index([invoiceId])
}

// Посилання (реферальні посилання)
model Link {
  id        Int      @id @default(autoincrement())
  linkName  String
  linkUrl   String?
  linkCount Int      @default(0)

  @@index([linkName])
}

